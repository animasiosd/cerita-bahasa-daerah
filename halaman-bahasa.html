<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Memuat Cerita...</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">

    <style>
        /* Semua CSS Anda sebelumnya sudah benar, tidak ada perubahan di sini */
        #page-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #ffffff; display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 9999; transition: opacity 0.75s ease-out; }
        .google-spinner { width: 28px; height: 28px; border-radius: 50%; border: 4px solid #f3f3f3; border-top: 4px solid #4285F4; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #page-loader.hidden { opacity: 0; }
        #loader-text { color: #555; margin-top: 20px; font-size: 1.2em; }
        .progress-container { width: 80%; max-width: 400px; background-color: #e0e0e0; border-radius: 25px; overflow: hidden; }
        #progress-bar { width: 0%; height: 20px; background-color: #0d6efd; border-radius: 25px; transition: width 0.1s linear; }
        #loginContainer, #mainContent { display: none; }
    </style>
</head>

<body>

    <div id="page-loader">
        <div class="progress-container">
            <div id="progress-bar"></div>
        </div>
        <div id="loader-text">Memuat... 0%</div>
    </div>

    <div id="loginContainer" class="d-flex justify-content-center align-items-center vh-100">
        <div class="text-center">
            <h1 class="mb-3">Cerita Bahasa Daerah</h1>
            <p class="mb-4">Masuk untuk menjelajahi cerita dari berbagai daerah.</p>
            <button id="loginBtn" class="btn btn-primary btn-lg">Login dengan Google</button>
        </div>
    </div>

    <div id="mainContent">
        <div id="navbar-placeholder"></div>
        <main class="container my-4">
            <div class="row justify-content-center">
                <div class="col-lg-10 col-xl-8">
                    <h2 id="videoTitle" class="text-center mb-3">
                        <div class="google-spinner"></div>
                    </h2>
                    <div class="input-group mb-3">
                        <label class="input-group-text" for="videoSelect">Pilih Video:</label>
                        <select class="form-select" id="videoSelect" onchange="playSelectedVideo()"></select>
                    </div>
                    <div class="ratio ratio-16x9 shadow-sm rounded overflow-hidden">
                        <iframe id="videoPlayer" src="" allowfullscreen title="Pemutar Video YouTube"></iframe>
                    </div>
                    <div class="card mt-4">
                        <div class="card-header h5">Pertanyaan Diskusi</div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item">1. Menurut Anda, cerita ini menceritakan tentang apa?</li>
                                <li class="list-group-item">2. Menurut Anda, apa yang paling menarik pada cerita ini?</li>
                                <li class="list-group-item">3. Apa yang Anda pelajari dari cerita ini?</li>
                                <li class="list-group-item">4. Bagaimana Anda akan menerapkan apa yang baru kita pelajari dari cerita ini?</li>
                                <li class="list-group-item">5. Menurut Anda, apakah bahasa yang dipakai dalam cerita mudah dipahami?</li>
                                <li class="list-group-item">6. Apa harapan Anda terkait pelestarian bahasa <strong id="language-name-placeholder">ini</strong>?</li>
                            </ul>
                        </div>
                    </div>

                    <div id="comment-feature" class="mt-5">
                        <h3 class="mb-3">Komentar</h3>
                        <form id="comment-form" class="mb-4">
                            <div class="d-flex align-items-start">
                                <div id="user-photo-container" class="me-3"></div>
                                <div class="flex-grow-1">
                                    <textarea id="comment-input" class="form-control" rows="2" placeholder="Tulis komentar..." required></textarea>
                                    <div class="text-end mt-2">
                                        <button type="submit" class="btn btn-primary">Kirim</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                        <div id="comment-section"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/main.js"></script>
    <script src="js/auth.js"></script>
  
    <script>
        // --- VARIABEL GLOBAL & KONSTANTA ---
        const WEB_APP_URL_VIDEOS = "https://script.google.com/macros/s/AKfycbz0r5Tvw0M2ptBsD4oKDtuCe8Hi1ygfVfM2ubDObGEWMuv04N382-Y0dZFCsBi9RUpv/exec";
        const WEB_APP_URL_COMMENTS = "https://script.google.com/macros/s/AKfycbwlCVUzCu9GEdi2aCZnzj-HYFXJlNX25sBEBDvivqGg2kyJrpfQZ6Jr31cknT_fcGu5_g/exec";
        const API_KEY_YOUTUBE = "AIzaSyDBefJ54bf1RQBrmMye6FjD-gyPLT3bOyU"; // INGAT: Ini tidak aman, pindahkan ke backend
        let currentVideoId = null;

        // --- ALUR UTAMA HALAMAN ---
        document.addEventListener("DOMContentLoaded", () => {
            const pageLoader = document.getElementById('page-loader');
            const progressBar = document.getElementById('progress-bar');
            const loaderText = document.getElementById('loader-text');
            let progress = 0;
            const loadingSpeed = 5;

            const interval = setInterval(() => {
                progress += 1;
                progressBar.style.width = progress + '%';
                loaderText.textContent = 'Memuat... ' + progress + '%';
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        pageLoader.classList.add('hidden');
                        setTimeout(() => {
                            pageLoader.style.display = 'none';
                            initializePage();
                        }, 750);
                    }, 500);
                }
            }, loadingSpeed);

            document.getElementById('comment-form').addEventListener('submit', handleCommentSubmit);
        });

        function initializePage() {
            const loginContainer = document.getElementById('loginContainer');
            const mainContent = document.getElementById('mainContent');
            const urlParams = new URLSearchParams(window.location.search);
            const bahasa = urlParams.get('bahasa');

            if (!bahasa) {
                window.location.href = 'index.html';
                return;
            }

            document.title = `${formatBahasaName(bahasa)} - Cerita Bahasa Daerah`;

            auth.onAuthStateChanged(user => {
                if (user) {
                    mainContent.style.display = 'block';
                    loginContainer.style.display = 'none';
                    document.getElementById('user-photo-container').innerHTML = `<img src="${user.photoURL}" alt="${user.displayName}" class="rounded-circle" style="width: 40px; height: 40px;">`;
                    loadNavbar();
                    loadVideoData(bahasa);
                } else {
                    mainContent.style.display = 'none';
                    document.getElementById('navbar-placeholder').innerHTML = '';
                    loginContainer.style.display = 'flex';
                }
            });
        }

        // --- FUNGSI-FUNGSI FITUR ---

        function loadNavbar() {
            fetch('navbar.html')
                .then(response => response.ok ? response.text() : Promise.reject('Navbar not found'))
                .then(html => { document.getElementById('navbar-placeholder').innerHTML = html; })
                .catch(error => console.error('Gagal memuat navbar:', error));
        }

        function loadVideoData(namaBahasa) {
            document.getElementById('language-name-placeholder').textContent = formatBahasaName(namaBahasa);
            const videoSelect = document.getElementById("videoSelect");
            
            fetch(`${WEB_APP_URL_VIDEOS}?bahasa=${namaBahasa}`)
                .then(response => response.json())
                .then(resultArray => {
                    const matched = resultArray.find(item => item.bahasa === namaBahasa);
                    if (!matched || !matched.playlistId) throw new Error(`Playlist ID untuk '${namaBahasa}' tidak ditemukan.`);
                    return fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${matched.playlistId}&maxResults=50&key=${API_KEY_YOUTUBE}`);
                })
                .then(response => response.json())
                .then(data => {
                    videoSelect.innerHTML = ''; // Kosongkan dulu
                    if (data.items && data.items.length > 0) {
                        data.items.forEach((item, index) => {
                            const videoId = item.snippet.resourceId.videoId;
                            const title = item.snippet.title;
                            const option = new Option(title, videoId);
                            videoSelect.add(option);
                        });
                        // Setelah semua opsi ditambahkan, putar video pertama
                        playVideo(videoSelect.value, videoSelect.options[0].text);
                    } else {
                        document.getElementById("videoTitle").textContent = "Tidak ada video di playlist ini.";
                    }
                })
                .catch(error => {
                    document.getElementById("videoTitle").innerHTML = `<span class="text-danger">Gagal memuat daftar video.</span>`;
                    console.error("Gagal mengambil data video:", error);
                });
        }

        function playVideo(videoId, title) {
            currentVideoId = videoId;
            document.getElementById("videoPlayer").src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
            const videoTitleElement = document.getElementById("videoTitle");
            videoTitleElement.innerHTML = ''; // Hapus spinner
            videoTitleElement.textContent = title;
            loadComments(currentVideoId);
        }

        function playSelectedVideo() {
            const select = document.getElementById("videoSelect");
            if (select.options.length > 0) {
                 playVideo(select.value, select.options[select.selectedIndex].text);
            }
        }
        
        function loadComments(videoId) {
            const commentSection = document.getElementById('comment-section');
            commentSection.innerHTML = `<div class="text-center py-5"><div class="google-spinner"></div></div>`;

            fetch(`${WEB_APP_URL_COMMENTS}?video_id=${videoId}`)
                .then(response => response.json())
                .then(comments => {
                    commentSection.innerHTML = '';
                    if (!comments || comments.length === 0) {
                        commentSection.innerHTML = '<p class="text-center text-muted">Belum ada komentar. Jadilah yang pertama!</p>';
                    } else {
                        comments.forEach(comment => {
                            const commentElement = document.createElement('div');
                            commentElement.className = 'd-flex mb-3';
                            commentElement.innerHTML = `
                                <img src="${comment.user_photo_url}" alt="${comment.user_name}" class="rounded-circle me-3" style="width: 40px; height: 40px;">
                                <div class="flex-grow-1">
                                    <strong class="me-2">${comment.user_name}</strong>
                                    <small class="text-muted">${new Date(comment.timestamp).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' })}</small>
                                    <p class="mb-0 mt-1" style="white-space: pre-wrap;">${comment.comment_text}</p>
                                </div>
                            `;
                            commentSection.appendChild(commentElement);
                        });
                    }
                })
                .catch(error => {
                    console.error('Gagal memuat komentar:', error);
                    commentSection.innerHTML = '<p class="text-center text-danger">Maaf, gagal memuat komentar.</p>';
                });
        }

        function handleCommentSubmit(event) {
            event.preventDefault();
            const commentInput = document.getElementById('comment-input');
            const commentText = commentInput.value.trim();
            const user = auth.currentUser;

            if (!commentText || !user) {
                if (!user) alert("Anda harus login untuk berkomentar!");
                return;
            }

            const commentData = { videoId: currentVideoId, userId: user.uid, userName: user.displayName, userPhotoUrl: user.photoURL, commentText: commentText };
            const submitButton = event.target.querySelector('button');
            submitButton.disabled = true;

            fetch(WEB_APP_URL_COMMENTS, { method: 'POST', body: JSON.stringify(commentData) })
                .then(response => response.json())
                .then(result => {
                    if (result.status === "success") {
                        commentInput.value = '';
                        loadComments(currentVideoId);
                    } else { throw new Error(result.message || 'Gagal mengirim komentar.'); }
                })
                .catch(error => {
                    console.error('Error saat mengirim komentar:', error);
                    alert('Terjadi kesalahan saat mengirim komentar.');
                })
                .finally(() => { submitButton.disabled = false; });
        }

        function formatBahasaName(slug) {
            if (!slug) return "Tidak Dikenal";
            return slug.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }
    </script>
</body>
</html>