<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Memuat Cerita...</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

  <div id="loginContainer" class="d-flex justify-content-center align-items-center vh-100">
    <div class="text-center">
      <h1 class="mb-3">Cerita Bahasa Daerah</h1>
      <p class="mb-4">Anda harus login untuk melihat halaman ini.</p>
      <button id="loginBtn" class="btn btn-primary btn-lg">Login dengan Google</button>
    </div>
  </div>

  <div id="mainContent" class="d-none">
    <div id="navbar-placeholder"></div>

    <main class="container my-4">
      <div id="videoTitle" class="h3 text-center mb-3">Memuat judul video...</div>
      
      <div class="d-flex justify-content-center mb-3">
        <select id="videoSelect" class="form-select w-auto" onchange="playSelectedVideo()">
          <option disabled selected>Pilih Video</option>
        </select>
      </div>

      <div class="d-flex justify-content-center">
        <div class="w-100" style="max-width: 800px; aspect-ratio: 16/9; background-color: #eee;">
            <iframe id="videoPlayer" class="w-100 h-100" src="" allowfullscreen border="0"></iframe>
        </div>
      </div>
      
      <div id="discussionQuestions" class="mx-auto" style="max-width: 800px; margin-top: 20px;">
        <h3 class="text-center">Pertanyaan Diskusi</h3>
        <ul class="list-unstyled">
          <li>1. Menurut Anda, cerita ini menceritakan tentang apa?</li>
          <li>2. Menurut Anda, apa yang paling menarik pada cerita ini?</li>
          <li>3. Apa yang Anda pelajari dari cerita ini?</li>
          <li>4. Bagaimana Anda akan menerapkan apa yang baru kita pelajari dari cerita ini?</li>
          <li>5. Menurut Anda, apakah bahasa yang dipakai dalam cerita mudah dipahami?</li>
          <li>6. Apa harapan Anda terkait pelestarian bahasa <strong id="language-name-placeholder">ini</strong> melalui cerita-cerita?</li>
        </ul>
      </div>
    </main>
  </div>

  <script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script src="js/main.js"></script>
  <script src="js/auth.js"></script>

  <script>
    // --- BAGIAN INTI DARI TEMPLATE DINAMIS ---
    const urlParams = new URLSearchParams(window.location.search);
    const bahasa = urlParams.get('bahasa');
    
    // Fungsi untuk mengubah 'toli-toli' menjadi 'Toli-Toli'
    function formatBahasaName(slug) {
        if (!slug) return "Tidak Dikenal";
        return slug.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    }
    const namaBahasaFormatted = formatBahasaName(bahasa);
    
    // Redirect jika tidak ada parameter bahasa
    if (!bahasa) {
        window.location.href = 'index.html';
    } else {
        // Atur konten dinamis setelah halaman dimuat
        document.addEventListener('DOMContentLoaded', () => {
            document.title = `${namaBahasaFormatted} - Cerita Bahasa Daerah`;
            const languageNamePlaceholder = document.getElementById('language-name-placeholder');
            if (languageNamePlaceholder) {
                languageNamePlaceholder.textContent = namaBahasaFormatted;
            }
            // Muat data video setelah memastikan user sudah login (dikelola oleh auth.js)
            // Kita panggil langsung di sini karena auth.js akan menangani visibilitas
            loadVideoData(bahasa); 
        });
    }
    // --- AKHIR BAGIAN INTI ---

    function playVideo(videoId, title) {
      const player = document.getElementById("videoPlayer");
      const titleDisplay = document.getElementById("videoTitle");
      player.src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
      titleDisplay.textContent = title;
    }

    function playSelectedVideo() {
      const select = document.getElementById("videoSelect");
      const selectedOption = select.options[select.selectedIndex];
      playVideo(selectedOption.value, selectedOption.textContent);
    }

    function loadVideoData(namaBahasa) {
      const API_KEY = "AIzaSyDBefJ54bf1RQBrmMye6FjD-gyPLT3bOyU"; // Sebaiknya simpan di tempat yang lebih aman
      const webAppURL = "https://script.google.com/macros/s/AKfycbz0r5Tvw0M2ptBsD4oKDtuCe8Hi1ygfVfM2ubDObGEWMuv04N382-Y0dZFCsBi9RUpv/exec";

      fetch(`${webAppURL}?bahasa=${namaBahasa}`)
        .then(response => response.json())
        .then(resultArray => {
          const matched = resultArray.find(item => item.bahasa === namaBahasa);
          if (!matched || !matched.playlistId) throw new Error(`Playlist ID untuk bahasa '${namaBahasa}' tidak ditemukan.`);
          return fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${matched.playlistId}&maxResults=50&key=${API_KEY}`);
        })
        .then(response => response.json())
        .then(data => {
          const videoSelect = document.getElementById("videoSelect");
          videoSelect.innerHTML = '<option disabled selected>Pilih Video</option>'; // Reset dropdown
          data.items.forEach((item, index) => {
            const videoId = item.snippet.resourceId.videoId;
            const title = item.snippet.title;
            const option = document.createElement("option");
            option.value = videoId;
            option.textContent = title;
            videoSelect.appendChild(option);
            if (index === 0) {
              playVideo(videoId, title);
              option.selected = true;
            }
          });
        })
        .catch(error => {
          document.getElementById("videoTitle").textContent = "Gagal memuat daftar video.";
          console.error("Gagal mengambil data:", error);
        });
    }
  </script>

</body>
</html>