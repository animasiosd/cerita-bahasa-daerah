<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Memuat Cerita...</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

  <div id="pageLoader" class="d-flex justify-content-center align-items-center vh-100">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div id="loginContainer" class="d-none d-flex justify-content-center align-items-center vh-100">
    <div class="text-center">
      <h1 class="mb-3">Cerita Bahasa Daerah</h1>
      <p class="mb-4">Anda harus login untuk dapat melihat halaman ini.</p>
      <button id="loginBtn" class="btn btn-primary btn-lg">Login dengan Google</button>
    </div>
  </div>

  <div id="mainContent" class="d-none">
    <div id="navbar-placeholder"></div>
    <main class="container my-4">
      <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">
          <h2 id="videoTitle" class="text-center mb-3">Memuat judul video...</h2>
          <div class="input-group mb-3">
            <label class="input-group-text" for="videoSelect">Pilih Video:</label>
            <select class="form-select" id="videoSelect" onchange="playSelectedVideo()"></select>
          </div>
          <div class="ratio ratio-16x9 shadow-sm rounded overflow-hidden">
            <iframe id="videoPlayer" src="" allowfullscreen title="Pemutar Video YouTube"></iframe>
          </div>
          <div class="card mt-4">
            <div class="card-header h5">Pertanyaan Diskusi</div>
            <div class="card-body">
              <ul class="list-group list-group-flush">
                <li class="list-group-item">1. Menurut Anda, cerita ini menceritakan tentang apa?</li>
                <li class="list-group-item">2. Menurut Anda, apa yang paling menarik pada cerita ini?</li>
                <li class="list-group-item">3. Apa yang Anda pelajari dari cerita ini?</li>
                <li class="list-group-item">4. Bagaimana Anda akan menerapkan apa yang baru kita pelajari dari cerita ini?</li>
                <li class="list-group-item">5. Menurut Anda, apakah bahasa yang dipakai dalam cerita mudah dipahami?</li>
                <li class="list-group-item">6. Apa harapan Anda terkait pelestarian bahasa <strong id="language-name-placeholder">ini</strong>?</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script src="js/main.js"></script>
  <script src="js/auth.js"></script>
  
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const bahasa = urlParams.get('bahasa');
    
    function formatBahasaName(slug) {
      if (!slug) return "Tidak Dikenal";
      return slug.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    }
    const namaBahasaFormatted = formatBahasaName(bahasa);
    
    if (!bahasa) {
      window.location.href = 'index.html';
    } else {
      document.title = `${namaBahasaFormatted} - Cerita Bahasa Daerah`;
      document.getElementById('language-name-placeholder').textContent = namaBahasaFormatted;
      auth.onAuthStateChanged(user => {
        if (user) {
          loadVideoData(bahasa);
        }
      });
    }

    function playVideo(videoId, title) {
      document.getElementById("videoPlayer").src = `https://www.youtube.com/embed/$${videoId}?autoplay=1`;
      document.getElementById("videoTitle").textContent = title;
    }

    function playSelectedVideo() {
      const select = document.getElementById("videoSelect");
      const selectedOption = select.options[select.selectedIndex];
      playVideo(selectedOption.value, selectedOption.textContent);
    }

    function loadVideoData(namaBahasa) {
      const API_KEY = "AIzaSyDBefJ54bf1RQBrmMye6FjD-gyPLT3bOyU";
      const webAppURL = "https://script.google.com/macros/s/AKfycbz0r5Tvw0M2ptBsD4oKDtuCe8Hi1ygfVfM2ubDObGEWMuv04N382-Y0dZFCsBi9RUpv/exec";

      fetch(`${webAppURL}?bahasa=${namaBahasa}`)
        .then(response => response.json())
        .then(resultArray => {
          const matched = resultArray.find(item => item.bahasa === namaBahasa);
          if (!matched || !matched.playlistId) throw new Error(`Playlist ID untuk bahasa '${namaBahasa}' tidak ditemukan.`);
          return fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${matched.playlistId}&maxResults=50&key=${API_KEY}`);
        })
        .then(response => response.json())
        .then(data => {
          const videoSelect = document.getElementById("videoSelect");
          videoSelect.innerHTML = '<option disabled selected>Pilih Video</option>';
          data.items.forEach((item, index) => {
            const videoId = item.snippet.resourceId.videoId;
            const title = item.snippet.title;
            const option = document.createElement("option");
            option.value = videoId;
            option.textContent = title;
            videoSelect.appendChild(option);
            if (index === 0) {
              playVideo(videoId, title);
              option.selected = true;
            }
          });
        })
        .catch(error => {
          document.getElementById("videoTitle").textContent = "Gagal memuat daftar video.";
          console.error("Gagal mengambil data:", error);
        });
    }
  </script>
</body>
</html>