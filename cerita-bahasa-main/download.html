<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Halaman Download Video Cerita</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; background-color: #f9f9f9; }
    h1 { text-align: center; margin-bottom: 1rem; }
    .filter-group, .nav-group { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; justify-content: center; }
    select { padding: 0.5rem; font-size: 1rem; }
    table { width: 100%; border-collapse: collapse; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    th { background-color: #eee; cursor: pointer; }
    tr:hover { background-color: #def; cursor: pointer; }
    .sortable::after { content: " ‚áÖ"; font-size: 0.8rem; color: #888; }
    .asc::after { content: " ‚Üë"; }
    .desc::after { content: " ‚Üì"; }
    @media (max-width: 600px) {
      .filter-group, .nav-group { flex-direction: column; align-items: stretch; }
    }
  </style>
</head>
<body>

  <!-- Navigasi ke Halaman Bahasa (pindah ke paling atas) -->
  <div class="nav-group" style="margin-bottom: 2rem;">
    <select id="languageNav">
      <option value="">-- Menu --</option>
      <option value="index.html">üè† Beranda</option>
      <option value="download.html">‚¨áÔ∏è Halaman Download</option>
      <option value="mandar">Bahasa Mandar</option>
      <option value="kaili-unde">Bahasa Kaili Unde</option>
      <option value="suwawa">Bahasa Suwawa</option>
      <option value="toli-toli">Bahasa Toli-Toli</option>
      <option value="wolio">Bahasa Wolio</option>
      <option value="muna">Bahasa Muna</option>
      <option value="bugis">Bahasa Bugis</option>
      <option value="toraja">Bahasa Toraja</option>
      <option value="balantak">Bahasa Balantak</option>
      <option value="pamona">Bahasa Pamona</option>
      <option value="daya">Bahasa Daya</option>
      <option value="makassar">Bahasa Makassar</option>
      <option value="bajo">Bahasa Bajo</option>
      <option value="moronene">Bahasa Moronene</option>
      <option value="banggai">Bahasa Banggai</option>
    </select>
  </div>

  <h1>Download Video Cerita</h1>

  <div class="filter-group">
    <select id="filterBahasa"><option value="">Semua Bahasa</option></select>
    <select id="filterUrutan"><option value="">Semua Urutan</option></select>
    <select id="filterJudul"><option value="">Semua Judul</option></select>
  </div>

  <table id="downloadTable">
    <thead>
      <tr>
        <th class="sortable" data-key="bahasa">Bahasa</th>
        <th class="sortable" data-key="urutan">Urutan</th>
        <th class="sortable" data-key="title">Title</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbyVZHGfb2xf-uPtKzqZ0bD4oIDttsBgF-n_aNXB0-h_Xy-oxYChmT-a4SYDV3MwiUpI/exec';
    let fullData = [];
    let sortKey = '';
    let sortAsc = true;

    async function fetchData() {
      try {
        const res = await fetch(API_URL);
        const json = await res.json();
        if (!Array.isArray(json)) throw new Error("Format data tidak sesuai");
        fullData = json;
        populateFilters(json);
        renderTable(json);
      } catch (err) {
        alert('Gagal memuat data. Pastikan API Google Apps Script sudah dipublikasikan sebagai "Anyone".');
        console.error(err);
      }
    }

    function populateFilters(data) {
      const bahasaSet = new Set();
      const urutanSet = new Set();
      const judulSet = new Set();

      data.forEach(item => {
        bahasaSet.add(item.bahasa);
        urutanSet.add(item.urutan);
        judulSet.add(item.title);
      });

      populateSelect('filterBahasa', [...bahasaSet].sort());
      populateSelect('filterUrutan', [...urutanSet].sort((a, b) => a - b));
      populateSelect('filterJudul', [...judulSet].sort());
    }

    function populateSelect(id, items) {
      const select = document.getElementById(id);
      items.forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val;
        select.appendChild(opt);
      });
    }

    function renderTable(data) {
      const tbody = document.querySelector('#downloadTable tbody');
      tbody.innerHTML = '';

      let sortedData = [...data];
      if (sortKey) {
        sortedData.sort((a, b) => {
          let valA = a[sortKey];
          let valB = b[sortKey];

          const numA = parseFloat(valA);
          const numB = parseFloat(valB);
          if (!isNaN(numA) && !isNaN(numB)) {
            valA = numA;
            valB = numB;
          }

          if (valA < valB) return sortAsc ? -1 : 1;
          if (valA > valB) return sortAsc ? 1 : -1;
          return 0;
        });
      }

      sortedData.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.bahasa}</td>
          <td>${row.urutan}</td>
          <td>${row.title}</td>
        `;
        tr.onclick = () => {
          window.open(row.link_download, '_blank');
        };
        tbody.appendChild(tr);
      });
    }

    function applyFilters() {
      const bahasa = document.getElementById('filterBahasa').value;
      const urutan = document.getElementById('filterUrutan').value;
      const judul = document.getElementById('filterJudul').value;

      const filtered = fullData.filter(item => {
        return (!bahasa || item.bahasa === bahasa)
            && (!urutan || item.urutan.toString() === urutan)
            && (!judul || item.title === judul);
      });

      renderTable(filtered);
    }

    function handleSort(event) {
      const key = event.target.getAttribute('data-key');
      if (sortKey === key) {
        sortAsc = !sortAsc;
      } else {
        sortKey = key;
        sortAsc = true;
      }

      document.querySelectorAll('th.sortable').forEach(th => {
        th.classList.remove('asc', 'desc');
        if (th.getAttribute('data-key') === sortKey) {
          th.classList.add(sortAsc ? 'asc' : 'desc');
        }
      });

      applyFilters();
    }

    document.querySelectorAll('select').forEach(select => {
      select.addEventListener('change', applyFilters);
    });

    document.querySelectorAll('th.sortable').forEach(th => {
      th.addEventListener('click', handleSort);
    });

    document.getElementById('languageNav').addEventListener('change', function () {
      const selected = this.value;
      if (selected) {
        window.location.href = selected;
      }
    });

    fetchData();
  </script>

</body>
</html>
